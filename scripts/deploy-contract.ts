import { ethers } from "ethers";
import * as dotenv from "dotenv";

dotenv.config();

// ABI for the TraceabilityStorage contract
const ABI = [
    "event RecordStored(bytes32 indexed recordHash, string metadataCid, uint256 timestamp, address indexed submitter)",
    "function storeRecord(bytes32 recordHash, string memory metadataCid) public",
    "function getRecord(bytes32 recordHash) public view returns (string memory metadataCid, uint256 timestamp, address submitter)",
    "function recordExists(bytes32 recordHash) public view returns (bool)",
];

// Compiled bytecode for TraceabilityStorage contract (compiled with solc 0.8.19)
const BYTECODE =
    "0x608060405234801561001057600080fd5b50610c4a806100206000396000f3fe608060405234801561001057600080fd5b506004361061004c5760003560e01c806301e6472514610051578063213681cd14610083578063f79fe538146100b5578063f923729f146100e5575b600080fd5b61006b60048036038101906100669190610512565b610101565b60405161007a93929190610629565b60405180910390f35b61009d60048036038101906100989190610512565b6101d3565b6040516100ac93929190610629565b60405180910390f35b6100cf60048036038101906100ca9190610512565b610308565b6040516100dc9190610682565b60405180910390f35b6100ff60048036038101906100fa91906107d2565b61032a565b005b60006020528060005260406000206000915090508060000180546101249061085d565b80601f01602080910402602001604051908101604052809291908181526020018280546101509061085d565b801561019d5780601f106101725761010080835404028352916020019161019d565b820191906000526020600020905b81548152906001019060200180831161018057829003601f168201915b5050505050908060010154908060020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905083565b606060008060008060008681526020019081526020016000206040518060600160405290816000820180546102079061085d565b80601f01602080910402602001604051908101604052809291908181526020018280546102339061085d565b80156102805780601f1061025557610100808354040283529160200191610280565b820191906000526020600020905b81548152906001019060200180831161026357829003601f168201915b50505050508152602001600182015481526020016002820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815250509050806000015181602001518260400151935093509350509193909250565b6000806000808481526020019081526020016000206001015414159050919050565b60008060008481526020019081526020016000206001015414610382576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610379906108da565b60405180910390fd5b60008151116103c6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103bd90610946565b60405180910390fd5b60405180606001604052808281526020014281526020013373ffffffffffffffffffffffffffffffffffffffff16815250600080848152602001908152602001600020600082015181600001908161041e9190610b12565b506020820151816001015560408201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509050503373ffffffffffffffffffffffffffffffffffffffff16827f380658d42a2057a49e0a0fd33fe60b7914181d9a61641eeb7b2a166c25fc375883426040516104bc929190610be4565b60405180910390a35050565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b6104ef816104dc565b81146104fa57600080fd5b50565b60008135905061050c816104e6565b92915050565b600060208284031215610528576105276104d2565b5b6000610536848285016104fd565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561057957808201518184015260208101905061055e565b60008484015250505050565b6000601f19601f8301169050919050565b60006105a18261053f565b6105ab818561054a565b93506105bb81856020860161055b565b6105c481610585565b840191505092915050565b6000819050919050565b6105e2816105cf565b82525050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610613826105e8565b9050919050565b61062381610608565b82525050565b600060608201905081810360008301526106438186610596565b905061065260208301856105d9565b61065f604083018461061a565b949350505050565b60008115159050919050565b61067c81610667565b82525050565b60006020820190506106976000830184610673565b92915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6106df82610585565b810181811067ffffffffffffffff821117156106fe576106fd6106a7565b5b80604052505050565b60006107116104c8565b905061071d82826106d6565b919050565b600067ffffffffffffffff82111561073d5761073c6106a7565b5b61074682610585565b9050602081019050919050565b82818337600083830152505050565b600061077561077084610722565b610707565b905082815260208101848484011115610791576107906106a2565b5b61079c848285610753565b509392505050565b600082601f8301126107b9576107b861069d565b5b81356107c9848260208601610762565b91505092915050565b600080604083850312156107e9576107e86104d2565b5b60006107f7858286016104fd565b925050602083013567ffffffffffffffff811115610818576108176104d7565b5b610824858286016107a4565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061087557607f821691505b6020821081036108885761088761082e565b5b50919050565b7f5265636f726420616c7265616479206578697374730000000000000000000000600082015250565b60006108c460158361054a565b91506108cf8261088e565b602082019050919050565b600060208201905081810360008301526108f3816108b7565b9050919050565b7f4d65746164617461204349442063616e6e6f7420626520656d70747900000000600082015250565b6000610930601c8361054a565b915061093b826108fa565b602082019050919050565b6000602082019050818103600083015261095f81610923565b9050919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026109c87fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261098b565b6109d2868361098b565b95508019841693508086168417925050509392505050565b6000819050919050565b6000610a0f610a0a610a05846105cf565b6109ea565b6105cf565b9050919050565b6000819050919050565b610a29836109f4565b610a3d610a3582610a16565b848454610998565b825550505050565b600090565b610a52610a45565b610a5d818484610a20565b505050565b5b81811015610a8157610a76600082610a4a565b600181019050610a63565b5050565b601f821115610ac657610a9781610966565b610aa08461097b565b81016020851015610aaf578190505b610ac3610abb8561097b565b830182610a62565b50505b505050565b600082821c905092915050565b6000610ae960001984600802610acb565b1980831691505092915050565b6000610b028383610ad8565b9150826002028217905092915050565b610b1b8261053f565b67ffffffffffffffff811115610b3457610b336106a7565b5b610b3e825461085d565b610b49828285610a85565b600060209050601f831160018114610b7c5760008415610b6a578287015190505b610b748582610af6565b865550610bdc565b601f198416610b8a86610966565b60005b82811015610bb257848901518255600182019150602085019450602081019050610b8d565b86831015610bcf5784890151610bcb601f891682610ad8565b8355505b6001600288020188555050505b505050505050565b60006040820190508181036000830152610bfe8185610596565b9050610c0d60208301846105d9565b939250505056fea2646970667358221220550e89b01d7fb5a25cadf1e02fe6eb7d3abc86622b889f9d88fa2617f532d57e64736f6c63430008130033";

async function main() {
    const rpcUrl = process.env.BLOCKCHAIN_RPC_URL;
    const privateKey = process.env.BLOCKCHAIN_PRIVATE_KEY;

    if (!rpcUrl || !privateKey) {
        console.error(
            "Missing BLOCKCHAIN_RPC_URL or BLOCKCHAIN_PRIVATE_KEY in .env"
        );
        process.exit(1);
    }

    console.log("Connecting to:", rpcUrl);

    const provider = new ethers.JsonRpcProvider(rpcUrl);
    const wallet = new ethers.Wallet(privateKey, provider);

    console.log("Deployer address:", wallet.address);

    const balance = await provider.getBalance(wallet.address);
    console.log("Balance:", ethers.formatEther(balance), "ETH");

    if (balance === BigInt(0)) {
        console.error(
            "Wallet has no balance. Please fund it with testnet ETH."
        );
        console.log(
            "For Base Sepolia, get testnet ETH from: https://www.coinbase.com/faucets/base-ethereum-goerli-faucet"
        );
        process.exit(1);
    }

    const network = await provider.getNetwork();
    console.log(
        "Network:",
        network.name,
        "(Chain ID:",
        network.chainId.toString(),
        ")"
    );

    console.log("\nDeploying TraceabilityStorage contract...");

    const factory = new ethers.ContractFactory(ABI, BYTECODE, wallet);
    const contract = await factory.deploy();

    console.log(
        "Deployment transaction:",
        contract.deploymentTransaction()?.hash
    );
    console.log("Waiting for confirmation...");

    await contract.waitForDeployment();
    const contractAddress = await contract.getAddress();

    console.log("\n========================================");
    console.log("Contract deployed successfully!");
    console.log("Contract address:", contractAddress);
    console.log("========================================");
    console.log("\nAdd this to your .env file:");
    console.log(`STORAGE_CONTRACT_ADDRESS=${contractAddress}`);
    console.log("\nView on explorer:");
    console.log(`https://sepolia.basescan.org/address/${contractAddress}`);
}

main().catch((error) => {
    console.error("Deployment failed:", error);
    process.exit(1);
});
